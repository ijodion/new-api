name: Build and Deploy New-API

on:
  workflow_dispatch:

jobs:
  # ======================================================================================
  # 任务 1: 编译 Linux armhf (Musl/Static) -> 压缩传输 (加速)
  # 修复：Gzip 压缩加速传输，解决电信跨国慢的问题
  # ======================================================================================
  deploy-armhf:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25.5'

      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest
      
      - name: Build Frontend
        env:
          CI: ""
        run: |
          cd web
          bun install
          DISABLE_ESLINT_PLUGIN='true' VITE_REACT_APP_VERSION=$VERSION bun run build
          cd ..

      - name: Setup Zig
        uses: goto-bus-stop/setup-zig@v2
        with:
          version: master

      # 1. 编译静态文件
      - name: Build Binary (Armv7 Musl Static)
        run: |
          CGO_ENABLED=1 GOOS=linux GOARCH=arm GOARM=7 CC="zig cc -target arm-linux-musleabihf" \
          go build -tags musl -ldflags "-s -w -linkmode external -extldflags '-static'" -o new-api-main .

      # 2. 关键步骤：Gzip 压缩 (体积减小约 70%，极大加速 SCP)
      - name: Compress Binary
        run: |
          gzip -9 new-api-main
          ls -lh new-api-main.gz

      # 3. 上传压缩包
      - name: Deploy to Server (IPv4 - Compressed)
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.HOST_ARMHF }}
          port: ${{ secrets.PORT_ARMHF }}
          username: root
          password: ${{ secrets.PASS_ARMHF }}
          source: "new-api-main.gz"
          target: "/tmp/"     # 直接传到 /tmp/ 目录下

      # 4. 解压并重启
      - name: Restart Service
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.HOST_ARMHF }}
          port: ${{ secrets.PORT_ARMHF }}
          username: root
          password: ${{ secrets.PASS_ARMHF }}
          script: |
            systemctl stop newapi.service
            
            # 解压并覆盖
            cd /tmp
            rm -f new-api-main # 清理旧的解压文件
            gunzip -f new-api-main.gz
            mv new-api-main /root/new-api/new-api-main
            
            chmod +x /root/new-api/new-api-main
            systemctl restart newapi.service
            echo "ARMHF Deployment Done!"

  # ======================================================================================
  # 任务 2: 编译 Linux arm64 -> 解决 IPv6 解析失败问题
  # 修复：手动解析 DNS 获取 IP，使用原生 SCP 传输
  # ======================================================================================
  deploy-arm64:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Enable IPv6 (via WARP)
        uses: fscarmen/warp-on-actions@v1.2
        with:
          stack: dual

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25.5'
          
      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest
          
      - name: Build Frontend
        env:
          CI: ""
        run: |
          cd web
          bun install
          DISABLE_ESLINT_PLUGIN='true' VITE_REACT_APP_VERSION=$VERSION bun run build
          cd ..

      - name: Setup Zig
        uses: goto-bus-stop/setup-zig@v2
        with:
          version: master

      - name: Build Binary (Arm64)
        run: |
          CGO_ENABLED=1 GOOS=linux GOARCH=arm64 CC="zig cc -target aarch64-linux-gnu" \
          go build -ldflags "-s -w" -o new-api-arm64 .
          # 同样压缩，虽然 IPv6 可能会快点，但压缩总是好的
          gzip -9 new-api-arm64

      # 关键修复：手动解析域名为 IPv6 地址，避免 ssh 无法解析
      - name: Resolve IPv6 & Deploy
        run: |
          sudo apt-get update && sudo apt-get install -y sshpass dnsutils
          
          # 强制获取 AAAA 记录 (IPv6)
          SERVER_IP=$(dig +short AAAA ${{ secrets.HOST_ARM64 }} | tail -n1)
          
          if [ -z "$SERVER_IP" ]; then
            echo "❌ Error: Could not resolve IPv6 address for host."
            exit 1
          fi
          
          echo "✅ Resolved IPv6: $SERVER_IP"
          
          # 使用 IP 地址进行 SCP
          sshpass -p "${{ secrets.PASS_ARM64 }}" scp -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -P ${{ secrets.PORT_ARM64 }} new-api-arm64.gz root@[$SERVER_IP]:/tmp/
          
          # 使用 IP 地址进行 SSH
          sshpass -p "${{ secrets.PASS_ARM64 }}" ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -p ${{ secrets.PORT_ARM64 }} root@[$SERVER_IP] "
            systemctl stop newapi.service
            cd /tmp
            gunzip -f new-api-arm64.gz
            mv new-api-arm64 /root/newapi/new-api-arm64-v0.9.27-patch.1
            chmod +x /root/newapi/new-api-arm64-v0.9.27-patch.1
            systemctl restart newapi.service
            echo 'ARM64 IPv6 Deployment Done!'
          "

  # ======================================================================================
  # 任务 3: 编译 Linux amd64 -> 解决路径错误
  # 修复：Target 指向目录根，防止创建多余文件夹
  # ======================================================================================
  deploy-amd64:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25.5'

      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest
          
      - name: Build Frontend
        env:
          CI: ""
        run: |
          cd web
          bun install
          DISABLE_ESLINT_PLUGIN='true' VITE_REACT_APP_VERSION=$VERSION bun run build
          cd ..

      - name: Build Binary (AMD64)
        run: |
          CGO_ENABLED=1 GOOS=linux GOARCH=amd64 \
          go build -ldflags "-s -w" -o new-api-amd64 .

      - name: Deploy to Server (IPv4)
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.HOST_AMD64 }}
          port: ${{ secrets.PORT_AMD64 }}
          username: root
          password: ${{ secrets.PASS_AMD64 }}
          source: "new-api-amd64"
          # 修复点：这里只写目录，不写自定义文件名，避免被识别为创建文件夹
          target: "/tmp/"

      - name: Restart Service
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.HOST_AMD64 }}
          port: ${{ secrets.PORT_AMD64 }}
          username: root
          password: ${{ secrets.PASS_AMD64 }}
          script: |
            systemctl stop newapi.service
            # 源文件现在位于 /tmp/new-api-amd64
            mv /tmp/new-api-amd64 /root/newapi/new-api-v0.9.27-patch.1
            chmod +x /root/newapi/new-api-v0.9.27-patch.1
            systemctl restart newapi.service
            echo "AMD64 IPv4 Deployment Done!"
