name: Build and Deploy New-API

on:
  workflow_dispatch:

jobs:
  # ======================================================================================
  # 任务 1: 编译 Linux armhf (Musl/Static) -> 发送到 IPv4 服务器
  # 场景：目标服务器 Glibc 极老，必须使用全静态编译
  # ======================================================================================
  deploy-armhf-musl:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25.5' # 建议使用稳定版 1.25.5 或 1.23

      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest
      
      - name: Build Frontend
        env:
          CI: ""
        run: |
          cd web
          bun install
          DISABLE_ESLINT_PLUGIN='true' VITE_REACT_APP_VERSION=$VERSION bun run build
          cd ..

      - name: Setup Zig
        uses: goto-bus-stop/setup-zig@v2
        with:
          version: master

      # 关键修改：
      # 1. CC 使用 musleabihf
      # 2. ldflags 加入 "-linkmode external" 强制使用 Zig 进行链接，修复符号丢失问题
      - name: Build Binary (Armv7 Musl Static)
        run: |
          CGO_ENABLED=1 GOOS=linux GOARCH=arm GOARM=7 CC="zig cc -target arm-linux-musleabihf" \
          go build -tags musl -ldflags "-s -w -linkmode external -extldflags '-static'" -o new-api-main .

      # 使用临时文件名避免覆盖错误
      - name: Deploy to Server (IPv4)
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.HOST_ARMHF }}
          port: ${{ secrets.PORT_ARMHF }}
          username: root
          password: ${{ secrets.PASS_ARMHF }}
          source: "new-api-main"
          target: "/tmp/new-api-main-upload"

      - name: Restart Service
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.HOST_ARMHF }}
          port: ${{ secrets.PORT_ARMHF }}
          username: root
          password: ${{ secrets.PASS_ARMHF }}
          script: |
            systemctl stop newapi.service
            # 移动覆盖
            mv /tmp/new-api-main-upload /root/new-api/new-api-main
            chmod +x /root/new-api/new-api-main
            systemctl restart newapi.service
            echo "ARMHF IPv4 (Static Musl) Deployment Done!"

  # ======================================================================================
  # 任务 2: 编译 Linux arm64 -> 发送到 IPv6 单栈服务器
  # 场景：WARP 环境下 appleboy/scp-action DNS 解析失败，改用原生命令
  # ======================================================================================
  deploy-arm64:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Enable IPv6 (via WARP)
        uses: fscarmen/warp-on-actions@v1.2
        with:
          stack: dual

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25.5'
          
      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest
          
      - name: Build Frontend
        env:
          CI: ""
        run: |
          cd web
          bun install
          DISABLE_ESLINT_PLUGIN='true' VITE_REACT_APP_VERSION=$VERSION bun run build
          cd ..
          
      - name: Setup Zig
        uses: goto-bus-stop/setup-zig@v2
        with:
          version: master

      - name: Build Binary (Arm64)
        run: |
          CGO_ENABLED=1 GOOS=linux GOARCH=arm64 CC="zig cc -target aarch64-linux-gnu" \
          go build -ldflags "-s -w" -o new-api-arm64 .

      # 修正：使用原生 scp + sshpass
      - name: Deploy to Server (IPv6 Native)
        run: |
          sudo apt-get update && sudo apt-get install -y sshpass
          # 1. 传输到 /tmp
          sshpass -p "${{ secrets.PASS_ARM64 }}" scp -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -P ${{ secrets.PORT_ARM64 }} new-api-arm64 root@${{ secrets.HOST_ARM64 }}:/tmp/new-api-arm64-upload
          
          # 2. SSH 执行替换和重启
          sshpass -p "${{ secrets.PASS_ARM64 }}" ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -p ${{ secrets.PORT_ARM64 }} root@${{ secrets.HOST_ARM64 }} "
            systemctl stop newapi.service
            mv /tmp/new-api-arm64-upload /root/newapi/new-api-arm64-v0.9.27-patch.1
            chmod +x /root/newapi/new-api-arm64-v0.9.27-patch.1
            systemctl restart newapi.service
            echo 'ARM64 IPv6 Deployment Done!'
          "

  # ======================================================================================
  # 任务 3: 编译 Linux amd64 -> 发送到 IPv4 服务器
  # 场景：解决 Text file busy
  # ======================================================================================
  deploy-amd64:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25.5'

      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest
          
      - name: Build Frontend
        env:
          CI: ""
        run: |
          cd web
          bun install
          DISABLE_ESLINT_PLUGIN='true' VITE_REACT_APP_VERSION=$VERSION bun run build
          cd ..

      - name: Build Binary (AMD64)
        run: |
          CGO_ENABLED=1 GOOS=linux GOARCH=amd64 \
          go build -ldflags "-s -w" -o new-api-amd64 .

      - name: Deploy to Server (IPv4)
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.HOST_AMD64 }}
          port: ${{ secrets.PORT_AMD64 }}
          username: root
          password: ${{ secrets.PASS_AMD64 }}
          source: "new-api-amd64"
          target: "/tmp/new-api-amd64-upload"

      - name: Restart Service
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.HOST_AMD64 }}
          port: ${{ secrets.PORT_AMD64 }}
          username: root
          password: ${{ secrets.PASS_AMD64 }}
          script: |
            systemctl stop newapi.service
            mv /tmp/new-api-amd64-upload /root/newapi/new-api-v0.9.27-patch.1
            chmod +x /root/newapi/new-api-v0.9.27-patch.1
            systemctl restart newapi.service
            echo "AMD64 IPv4 Deployment Done!"
