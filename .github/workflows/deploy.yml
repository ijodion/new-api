name: Build and Deploy New-API

on:
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨å•ç‹¬è·‘éƒ¨ç½²
  workflow_run:      # ç›‘å¬ Sync ä»»åŠ¡
    workflows: ["Upstream Sync"] # å¿…é¡»å’Œ sync.yml é‡Œçš„ name ä¸€æ¨¡ä¸€æ ·
    types:
      - completed
jobs:
  # ======================================================================================
  # ä»»åŠ¡ 1: ç¼–è¯‘ Linux armhf (Musl/Static) -> å‹ç¼©ä¼ è¾“ (åŠ é€Ÿ)
  # ä¿®å¤ï¼šGzip å‹ç¼©åŠ é€Ÿä¼ è¾“ï¼Œè§£å†³ç”µä¿¡è·¨å›½æ…¢çš„é—®é¢˜
  # ======================================================================================
  deploy-armhf:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25.5'

      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest
      
      - name: Build Frontend
        env:
          CI: ""
        run: |
          cd web
          bun install
          DISABLE_ESLINT_PLUGIN='true' VITE_REACT_APP_VERSION=$VERSION bun run build
          cd ..

      - name: Setup Zig
        uses: goto-bus-stop/setup-zig@v2
        with:
          version: master

      # 1. ç¼–è¯‘é™æ€æ–‡ä»¶
      - name: Build Binary (Armv7 Musl Static)
        run: |
          CGO_ENABLED=1 GOOS=linux GOARCH=arm GOARM=7 CC="zig cc -target arm-linux-musleabihf" \
          go build -tags musl -ldflags "-s -w -linkmode external -extldflags '-static'" -o new-api-main .

      # 2. å…³é”®æ­¥éª¤ï¼šGzip å‹ç¼© (ä½“ç§¯å‡å°çº¦ 70%ï¼Œæå¤§åŠ é€Ÿ SCP)
      - name: Compress Binary
        run: |
          gzip -9 new-api-main
          ls -lh new-api-main.gz

      # 3. ä¸Šä¼ å‹ç¼©åŒ…
      - name: Deploy to Server (IPv4 - Compressed)
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.HOST_ARMHF }}
          port: ${{ secrets.PORT_ARMHF }}
          username: root
          password: ${{ secrets.PASS_ARMHF }}
          source: "new-api-main.gz"
          target: "/tmp/"     # ç›´æ¥ä¼ åˆ° /tmp/ ç›®å½•ä¸‹

      # 4. è§£å‹å¹¶é‡å¯
      - name: Restart Service
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.HOST_ARMHF }}
          port: ${{ secrets.PORT_ARMHF }}
          username: root
          password: ${{ secrets.PASS_ARMHF }}
          script: |
            systemctl stop newapi.service
            
            # è§£å‹å¹¶è¦†ç›–
            cd /tmp
            rm -f new-api-main # æ¸…ç†æ—§çš„è§£å‹æ–‡ä»¶
            gunzip -f new-api-main.gz
            mv new-api-main /root/new-api/new-api-main
            
            chmod +x /root/new-api/new-api-main
            systemctl restart newapi.service
            echo "ARMHF Deployment Done!"

  # ======================================================================================
  # ä»»åŠ¡ 2: ç¼–è¯‘ Linux arm64 -> è§£å†³ IPv6 æ‹¬å·è¯­æ³•é—®é¢˜
  # ======================================================================================
  deploy-arm64:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Enable IPv6 (via WARP)
        uses: fscarmen/warp-on-actions@v1.2
        with:
          stack: dual
      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25.5'
          
      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest
          
      - name: Build Frontend
        env:
          CI: ""
        run: |
          cd web
          bun install
          DISABLE_ESLINT_PLUGIN='true' VITE_REACT_APP_VERSION=$VERSION bun run build
          cd ..
      - name: Setup Zig
        uses: goto-bus-stop/setup-zig@v2
        with:
          version: master
      - name: Build Binary (Arm64)
        run: |
          CGO_ENABLED=1 GOOS=linux GOARCH=arm64 CC="zig cc -target aarch64-linux-gnu" \
          go build -ldflags "-s -w" -o new-api-arm64 .
          # å‹ç¼©æ–‡ä»¶
          gzip -9 new-api-arm64
      - name: Resolve IPv6 & Deploy
        run: |
          sudo apt-get update && sudo apt-get install -y sshpass dnsutils
          
          # 1. è§£æ IPv6 åœ°å€
          SERVER_IP=$(dig +short AAAA ${{ secrets.HOST_ARM64 }} | tail -n1)
          
          if [ -z "$SERVER_IP" ]; then
            echo "âŒ Error: Could not resolve IPv6 address for host."
            exit 1
          fi
          echo "âœ… Resolved IPv6: $SERVER_IP"
          
          # 2. SCP ä¼ è¾“ (å¿…é¡»å¸¦æ–¹æ‹¬å· [])
          # è¯­æ³•: user@[ipv6]:/path
          echo "ğŸ“‚ Starting SCP..."
          sshpass -p "${{ secrets.PASS_ARM64 }}" scp -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -P ${{ secrets.PORT_ARM64 }} new-api-arm64.gz root@[${SERVER_IP}]:/tmp/
          
          # 3. SSH æ‰§è¡Œ (å¿…é¡»å»æ‰æ–¹æ‹¬å·ï¼Œå¦åˆ™æ— æ³•è§£æ)
          # è¯­æ³•: user@ipv6
          echo "ğŸš€ Starting SSH..."
          sshpass -p "${{ secrets.PASS_ARM64 }}" ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -p ${{ secrets.PORT_ARM64 }} root@${SERVER_IP} "
            systemctl stop newapi.service
            cd /tmp
            gunzip -f new-api-arm64.gz
            mv new-api-arm64 /root/newapi/new-api-arm64-v0.9.27-patch.1
            chmod +x /root/newapi/new-api-arm64-v0.9.27-patch.1
            systemctl restart newapi.service
            echo 'ARM64 IPv6 Deployment Done!'
          "

  # ======================================================================================
  # ä»»åŠ¡ 3: ç¼–è¯‘ Linux amd64 -> è§£å†³è·¯å¾„é”™è¯¯
  # ä¿®å¤ï¼šTarget æŒ‡å‘ç›®å½•æ ¹ï¼Œé˜²æ­¢åˆ›å»ºå¤šä½™æ–‡ä»¶å¤¹
  # ======================================================================================
  deploy-amd64:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25.5'

      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest
          
      - name: Build Frontend
        env:
          CI: ""
        run: |
          cd web
          bun install
          DISABLE_ESLINT_PLUGIN='true' VITE_REACT_APP_VERSION=$VERSION bun run build
          cd ..

      - name: Build Binary (AMD64)
        run: |
          CGO_ENABLED=1 GOOS=linux GOARCH=amd64 \
          go build -ldflags "-s -w" -o new-api-amd64 .

      - name: Deploy to Server (IPv4)
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.HOST_AMD64 }}
          port: ${{ secrets.PORT_AMD64 }}
          username: root
          password: ${{ secrets.PASS_AMD64 }}
          source: "new-api-amd64"
          # ä¿®å¤ç‚¹ï¼šè¿™é‡Œåªå†™ç›®å½•ï¼Œä¸å†™è‡ªå®šä¹‰æ–‡ä»¶åï¼Œé¿å…è¢«è¯†åˆ«ä¸ºåˆ›å»ºæ–‡ä»¶å¤¹
          target: "/tmp/"

      - name: Restart Service
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.HOST_AMD64 }}
          port: ${{ secrets.PORT_AMD64 }}
          username: root
          password: ${{ secrets.PASS_AMD64 }}
          script: |
            systemctl stop newapi.service
            # æºæ–‡ä»¶ç°åœ¨ä½äº /tmp/new-api-amd64
            mv /tmp/new-api-amd64 /root/newapi/new-api-v0.9.27-patch.1
            chmod +x /root/newapi/new-api-v0.9.27-patch.1
            systemctl restart newapi.service
            echo "AMD64 IPv4 Deployment Done!"
